upstream phpfpm {
    server 127.0.0.1:9999;
    #server unix:/var/run/php-fpm/bal-api.soc;
}

server {
    listen              80;

    server_name _;

    root                /var/www/gemv1.bal-api.app/live/web;

    error_log   /var/www/gemv1.bal-api.app.vhost.logs/nginx.errors.logs;
    access_log  /var/www/gemv1.bal-api.app.vhost.logs/nginx.access.logs quick;


	# Deny all .* Files
	location ~ /\. {
		deny all;
	}

	location ~ ^/nginx_status {
		stub_status     on;
		access_log      off;
	}

	location ~ ^/(fpm_status|ping|phpinfo.php|apc.php) {
		access_log	off;
        	fastcgi_pass	phpfpm;
        	fastcgi_param	SCRIPT_FILENAME $document_root$fastcgi_script_name;
        	fastcgi_param	HTTPS off;
		include fastcgi_params;
	}

    # Proxy all Requests
    # For: https://api.bridgemanimages.com/enduser/login/shibboleth
    # To: BAL-API v1
    #

    location ~ /enduser/login/shibboleth {
        resolver        8.8.8.8;
        proxy_pass      https://api-v1.bridgemanimages.com;

        proxy_set_header Host           $host;
        proxy_set_header X-Real-IP      $remote_addr;
        proxy_set_header X-Forwared-For $proxy_add_x_forwarded_for;

	proxy_pass_request_headers on;
    }



    # Proxy all Requests
    # For: https://api.bridgemanimages.com/Shibboleth.sso/*
    # To: BAL-API v1
    #

    location ~ /Shibboleth.sso {
        resolver        8.8.8.8;
        proxy_pass      https://api-v1.bridgemanimages.com;

        proxy_set_header Host           $host;
        proxy_set_header X-Real-IP      $remote_addr;
        proxy_set_header X-Forwared-For $proxy_add_x_forwarded_for;

	proxy_pass_request_headers on;
    }
	
	# Strip app.php/ Prefix if it is present
	rewrite ^/app\.php/?(.*)$ /$1 permanent;

	location / {
		index app.php;
		try_files $uri @rewriteapp;
	}

	location @rewriteapp {
		rewrite ^(.*)$ /app.php/$1 last;
	}


	# Pass all Symfony related PHP scripts to FastCGI server from upstream phpfcgi
	location ~ ^/app\.php(/|$) {
		fastcgi_pass			phpfpm;
		fastcgi_split_path_info		^(.+\.php)(/.*)$;
		fastcgi_param	SCRIPT_FILENAME	$document_root$fastcgi_script_name;
		include fastcgi_params;
		internal;
	}


	# return 404 for all other php files not matching the front controller
	# this prevents access to other php files you don't want to be accessible.
	location ~ \.php$ {
		return 404;
	}

	
	location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
		access_log        on;
		log_not_found     on;
		expires           30d;
	}

}
